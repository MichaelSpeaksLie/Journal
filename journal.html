<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Journal</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Flatpickr CSS + JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    body {
      background: #18191A;
      color: #e4e6eb;
      font-family: 'Fira Mono', 'Consolas', 'Menlo', monospace;
      margin: 0;
    }
    h1 {
      text-align: center;
      letter-spacing: 2px;
      margin: 40px 0 28px 0;
      font-size: 2.8em;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-bottom: 32px;
    }
    .btn {
      background: #242526;
      color: #fff;
      border: 1px solid #35363a;
      padding: 14px 28px;
      border-radius: 6px;
      font-family: inherit;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.14s;
      font-size: 1.07em;
      box-shadow: 0 1px 3px #0a0a0a15;
      letter-spacing: 1px;
    }
    .btn:hover {
      background: #3a3b3c;
      color: #61dafb;
      box-shadow: 0 2px 8px #3333cc22;
    }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222325;
      border: 2px solid #61dafb;
      border-radius: 16px;
      box-shadow: 0 6px 32px #16193cbb;
      z-index: 9999;
      width: 360px;
      max-height: 80vh;
      overflow: auto;
      padding: 28px;
      color: #e4e6eb;
      text-align: center;
    }
    .modal h2 {
      margin-bottom: 18px;
      font-size: 1.4em;
    }
    .modal-backdrop {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(40,41,43,0.6);
      z-index: 9998;
    }
    .note {
      background: #222325;
      border: 1.8px solid #313235;
      border-radius: 10px;
      margin: 24px auto;
      padding: 20px 18px;
      box-shadow: 0 3px 10px #13141540;
      max-width: 700px;
      font-size: 1.08em;
    }
    .note .section-header {
      font-weight: bold;
      margin-top: 14px;
      margin-bottom: 4px;
      color: #87f7ca;
      font-size: 1.08em;
    }
    .note .completed { color: #22ff3b; text-decoration: line-through;}
    .note .incomplete, .note .pending { color: #ffd700;}
    .note .missed { color: #ff2266;}
    .disabled {
      opacity: 0.62;
      pointer-events: none;
      text-decoration: line-through;
    }
    textarea, input[type="date"], input[type="text"], input[type="datetime-local"], select {
      background: #23242a;
      color: #e4e6eb;
      border: 1.2px solid #38393c;
      border-radius: 5px;
      width: 100%;
      padding: 11px 18px;
      font-size: 1.09em;
      font-family: inherit;
      margin-bottom: 12px;
    }
    textarea {resize: vertical;}
    textarea:focus, input:focus, select:focus { border: 1.8px solid #61dafb; outline: none;}
    .notif {
      position: fixed;
      right: 32px;
      bottom: 32px;
      background: #ffe066;
      color: #242526;
      padding: 18px 23px;
      border-radius: 12px;
      border: 2.2px solid #856404;
      box-shadow: 0 4px 20px #19191977;
      z-index: 999;
      font-size: 1.22em;
      display: flex;
      align-items: center;
      font-family: inherit;
    }
    .notif .close {
      background: none;
      border: none;
      font-size: 1.1em;
      margin-left: 18px;
      cursor: pointer;
      color: #856404;
      padding: 4px 10px;
    }
    .task-list {
      margin: 14px 0 0 0;
      padding-left: 10px;
      text-align: left;
      max-height: 160px;
      overflow-y: auto;
      border: 1px solid #38393c;
      border-radius: 4px;
      background: #1d1e21;
    }
    .modal-btn-group {
      display: flex;
      justify-content: center;
      margin-top: 16px;
      gap: 14px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <!-- Login Modal and Backdrop -->
  <div id="loginModal" class="modal">
    <h2>Login</h2>
    <input type="text" id="loginUsername" placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <div class="modal-btn-group">
      <button class="btn" id="loginBtn">Login</button>
    </div>
  </div>
  <div id="loginBackdrop" class="modal-backdrop"></div>

  <h1 id="journalHeader" style="display:none;">Journal</h1>
  <div class="controls" id="journalControls" style="display:none;">
    <button class="btn" onclick="startTaskEntry()">âž• Add Entry</button>
    <button class="btn" onclick="showPrevTasks()">Prev. Tasks</button>
    <button class="btn" onclick="exportAndClear()">Export & Clear</button>
  </div>
  <div id="tasks" style="display:none;"></div>
  <div id="notification"></div>
  <div id="report" style="display:none;"></div>

<script>
  // Predefined credentials
  const validUsername = 'imanuragkrverma@gmail.com';
  const validPassword = '23103920052340972004';

  // On page load: show login modal, hide journal UI
  window.onload = () => {
    document.getElementById('journalHeader').style.display = 'none';
    document.getElementById('journalControls').style.display = 'none';
    document.getElementById('tasks').style.display = 'none';

    document.getElementById('loginModal').style.display = 'block';
    document.getElementById('loginBackdrop').style.display = 'block';
  };

  document.getElementById('loginBtn').onclick = function() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (username === validUsername && password === validPassword) {
      // Hide login modal & backdrop
      document.getElementById('loginModal').style.display = 'none';
      document.getElementById('loginBackdrop').style.display = 'none';

      // Show journal UI
      document.getElementById('journalHeader').style.display = 'block';
      document.getElementById('journalControls').style.display = 'flex';
      document.getElementById('tasks').style.display = 'block';

      // Load tasks and render
      tasks = loadTasks();
      renderTasks();
      checkNotifications();
    } else {
      alert('Invalid username or password.');
    }
  };

  let tasks = loadTasks();
  let notifDismissed = false;

  // Don't render tasks or notifications until login success

  // All below functions as in your original code (startTaskEntry, stepDateInput, stepTypeInput, stepCategoryInput,
  // stepDeadlineInput, stepTaskInput, getDaySections, selectOtherSection, saveTaskEntry, renderTasks,
  // editEntry, editSingleTask, deleteSingleTask, showPrevTasks, checkNotifications, dismissNotif,
  // exportAndClear, generateReport, showReportModal, downloadPDF, clearAll, createModal, modalRemove,
  // saveTasks, loadTasks)

  function startTaskEntry() {
    stepDateInput();
  }

  function stepDateInput() {
    modalRemove();
    let modal = createModal('Select date', `
      <input id="dateInput" placeholder="Pick a date" />
      <div class="modal-btn-group">
        <button class="btn" id="nextBtn" disabled>Next</button>
      </div>
    `);
    document.body.appendChild(modal);

    flatpickr("#dateInput", {
      dateFormat: "Y-m-d",
      onChange: function(selectedDates, dateStr) {
        document.getElementById('nextBtn').disabled = !dateStr;
      },
      allowInput: true
    });

    document.getElementById('nextBtn').onclick = () => {
      let date = document.getElementById("dateInput").value;
      if (date) stepTypeInput(date);
    };
  }

  function stepTypeInput(date) {
    modalRemove();
    let modal = createModal('Task Type?', `
      <select id="typeSelect">
        <option value="accomplished">Accomplished</option>
        <option value="future">Future</option>
      </select>
      <div class="modal-btn-group"><button class="btn" id="typeNextBtn">Next</button></div>
    `);
    document.body.appendChild(modal);
    document.getElementById("typeNextBtn").onclick = () => {
      let type = document.getElementById("typeSelect").value;
      modalRemove();
      stepCategoryInput(date, type);
    };
  }

  function stepCategoryInput(date, type) {
    modalRemove();
    let modal = createModal('Select Category', `
      <select id="categorySelect">
        <option value="Tech">Tech</option>
        <option value="Core">Core</option>
        <option value="Other">Other</option>
      </select>
      <div class="modal-btn-group"><button class="btn" id="catNextBtn">Next</button></div>
    `);
    document.body.appendChild(modal);
    document.getElementById("catNextBtn").onclick = () => {
      let cat = document.getElementById("categorySelect").value;
      modalRemove();
      if (type === "future") stepDeadlineInput(date, type, cat);
      else stepTaskInput(date, type, cat, null, []);
    };
  }

  function stepDeadlineInput(date, type, cat) {
    modalRemove();
    let modal = createModal('Set Deadline for Future Task', `
      <input id="deadlineInput" placeholder="Pick date & time" />
      <div class="modal-btn-group">
        <button class="btn" id="deadNextBtn" disabled>Next</button>
      </div>
    `);
    document.body.appendChild(modal);

    flatpickr("#deadlineInput", {
      enableTime: true,
      dateFormat: "Y-m-d H:i",
      onChange: function(selectedDates, dateStr) {
        document.getElementById("deadNextBtn").disabled = !dateStr;
      },
      allowInput: true
    });

    document.getElementById("deadNextBtn").onclick = () => {
      let deadline = document.getElementById("deadlineInput").value;
      if (deadline) {
        modalRemove();
        stepTaskInput(date, type, cat, deadline, []);
      }
    };
  }

  function stepTaskInput(date, type, cat, deadline, newTasksArr) {
    modalRemove();
    let day = tasks.find(t => t.date === date);
    let prev = (day && day.sections[cat]) ? [...day.sections[cat]] : [];
    let combinedTasks = [...prev, ...newTasksArr];
    let modal = createModal(
      `Add to ${cat} [${type === "future" ? ("Future, deadline: " + (deadline || (day?.deadline || ""))) : "Accomplished"}]`,
      `
      <textarea id="taskText" placeholder="Type a task, press Add."></textarea>
      <div class="task-list">${combinedTasks.map((t, i) => `<div>${i + 1}. ${t}</div>`).join("")}</div>
      <div class="modal-btn-group">
        <button class="btn" id="addTaskBtn">Add Task</button>
        <button class="btn" id="doneTaskBtn">Done</button>
      </div>
      `
    );
    document.body.appendChild(modal);

    document.getElementById("addTaskBtn").onclick = () => {
      let txt = document.getElementById("taskText").value.trim();
      if (txt) {
        combinedTasks.push(txt);
        document.getElementById("taskText").value = "";
        document.querySelector(".task-list").innerHTML = combinedTasks.map((t, i) => `<div>${i + 1}. ${t}</div>`).join("");
      }
    };
    document.getElementById("doneTaskBtn").onclick = () => {
      if (combinedTasks.length > 0) {
        saveTaskEntry(date, type, cat, deadline, combinedTasks);
        modalRemove();
        selectOtherSection(date, type, deadline, getDaySections(date));
      }
    };
  }

  function getDaySections(date) {
    let day = tasks.find(t => t.date === date);
    return day ? { ...day.sections } : {};
  }

  function selectOtherSection(date, type, deadline, gathered) {
    let otherCats = ["Tech", "Core", "Other"].filter(c => !gathered[c]);
    if (otherCats.length === 0) return;
    let modal = createModal('Do you want to add tasks for another section?', `
      <select id="otherCatSelect">
        <option value="">No, done</option>
        ${otherCats.map(cat => `<option value="${cat}">${cat}</option>`).join("")}
      </select>
      <div class="modal-btn-group"><button class="btn" id="otherCatNextBtn">Next</button></div>
    `);
    document.body.appendChild(modal);
    document.getElementById("otherCatNextBtn").onclick = () => {
      let sel = document.getElementById("otherCatSelect").value;
      modalRemove();
      if (sel) {
        if (type === "future") stepTaskInput(date, type, sel, deadline, []);
        else stepTaskInput(date, type, sel, null, []);
      }
    };
  }

  function saveTaskEntry(date, type, cat, deadline, tasksArr) {
    let day = tasks.find(t => t.date === date);
    if (!day) {
      day = {
        date,
        type,
        deadline: type === "future" ? deadline : null,
        sections: {},
        completed: type === "accomplished",
        missed: false,
      };
      tasks.push(day);
    }
    day.sections[cat] = tasksArr;
    if (type === "future") day.deadline = deadline;
    saveTasks(tasks);
    renderTasks();
    checkNotifications();
  }

  function renderTasks() {
    let taskDiv = document.getElementById('tasks');
    taskDiv.innerHTML = "";
    let today = new Date().toISOString().slice(0, 10);
    let sortedTasks = [...tasks].sort((a, b) => a.date.localeCompare(b.date));
    sortedTasks.forEach((entry, idx) => {
      let cats = Object.keys(entry.sections);
      let isFuture = entry.type === "future";
      let canEditOrDelete = isFuture || (entry.date === today);
      let deadlineStr = isFuture && entry.deadline ? `<span style="color:#fde68a;">Deadline: ${entry.deadline}</span><br>` : '';
      let statusStr = isFuture
        ? (entry.missed ? '<span class="missed">Missed</span>' : '<span class="pending">Pending</span>')
        : (entry.completed ? '<span class="completed">Completed</span>' : '<span class="incomplete">Incomplete</span>');
      let sectionsHTML = cats.map(cat =>
        `<div class="section">
          <div class="section-header">${cat} (${entry.sections[cat].length} task${entry.sections[cat].length > 1 ? "s" : ""})</div>
          <ol>${entry.sections[cat].map(t => `<li>${t}</li>`).join('')}</ol>
        </div>`
      ).join("");
      taskDiv.innerHTML += `
        <div class="note ${!canEditOrDelete ? 'disabled' : ''}">
          <div><strong>Date:</strong> ${entry.date} ${deadlineStr} <br>
          <strong>Status:</strong> ${statusStr}</div>
          ${sectionsHTML}
          ${canEditOrDelete ? `<button class="btn" onclick="editEntry(${idx})">Edit</button>` : ""}
        </div>
      `;
    });
  }

  function editEntry(idx) {
    let entry = tasks[idx];
    let today = new Date().toISOString().slice(0, 10);
    if (!(entry.type === "future" || entry.date === today)) {
      alert("Can only edit today's tasks or any future tasks.");
      return;
    }
    let cats = Object.keys(entry.sections);
    let modal = createModal("Edit a task", `
      <select id="catEditSelect">${cats.map(c => `<option value="${c}">${c}</option>`).join("")}</select>
      <div id="taskSelectDiv"></div>
      <div class="modal-btn-group"><button class="btn" id="chooseCatEdit">Choose Category</button></div>
    `);
    document.body.appendChild(modal);
    document.getElementById("chooseCatEdit").onclick = () => {
      let cat = document.getElementById("catEditSelect").value;
      let tasksInCat = entry.sections[cat] || [];
      if (tasksInCat.length === 0) {
        alert("No tasks in category.");
        return;
      }
      let options = tasksInCat.map((t, i) => `<option value="${i}">${i + 1}. ${t}</option>`).join("");
      document.getElementById("taskSelectDiv").innerHTML = `
        <select id="taskNumSelect">${options}</select>
        <div class="modal-btn-group">
          <button class="btn" id="editSingleBtn">Edit Task</button>
          <button class="btn" id="deleteSingleBtn">Delete Task</button>
        </div>
      `;
      document.getElementById("editSingleBtn").onclick = () => {
        editSingleTask(idx, cat);
      };
      document.getElementById("deleteSingleBtn").onclick = () => {
        deleteSingleTask(idx, cat);
      };
    };
  }

  function editSingleTask(idx, cat) {
    let entry = tasks[idx];
    let i = +document.getElementById("taskNumSelect").value;
    let newTask = prompt("Edit this task:", entry.sections[cat][i]);
    if (newTask && newTask.trim()) {
      entry.sections[cat][i] = newTask.trim();
      saveTasks(tasks);
      renderTasks();
      modalRemove();
    }
  }

  function deleteSingleTask(idx, cat) {
    let entry = tasks[idx];
    let i = +document.getElementById("taskNumSelect").value;
    if (confirm("Delete this task?")) {
      entry.sections[cat].splice(i, 1);
      saveTasks(tasks);
      renderTasks();
      modalRemove();
    }
  }

  function showPrevTasks() {
    let taskDiv = document.getElementById('tasks');
    let pastList = tasks.filter(t =>
      t.type === "accomplished" &&
      t.date < new Date().toISOString().slice(0, 10)
    );
    if (pastList.length === 0) {
      alert("No previous tasks found.");
      return;
    }
    let html = pastList.sort((a, b) => a.date.localeCompare(b.date)).map(entry => {
      let cats = Object.keys(entry.sections);
      let sectionsHTML = cats.map(cat =>
        `<div class="section">
          <div class="section-header">${cat}</div>
          <ol>${entry.sections[cat].map((t, i) => `<li>${t}</li>`).join('')}</ol>
        </div>`
      ).join("");
      return `
        <div class="note">
          <div><strong>Date:</strong> ${entry.date}</div>
          <span class="completed">Completed</span>
          ${sectionsHTML}
        </div>
      `;
    }).join("");
    taskDiv.innerHTML = html;
  }

  function checkNotifications() {
    let now = new Date();
    let toast = document.getElementById('notification');
    let futureTasks = tasks.filter(t =>
      t.type === "future" &&
      !t.completed && !t.missed
    );
    futureTasks.forEach(t => {
      if (t.deadline && new Date(t.deadline) < now) {
        t.missed = true; t.completed = false;
      }
    });
    saveTasks(tasks);
    if (futureTasks.length > 0 && !notifDismissed) {
      toast.innerHTML = `
        <div class="notif">
          <span>ðŸ•’ You have some tasks to do.</span>
          <button class="close" onclick="dismissNotif()">âœ–</button>
        </div>`;
    } else {
      toast.innerHTML = "";
    }
  }

  function dismissNotif() {
    notifDismissed = true;
    document.getElementById('notification').innerHTML = "";
  }

  function exportAndClear() {
    let fullReport = generateReport();
    showReportModal(fullReport);
  }

  function generateReport() {
    let lines = [];
    lines.push("JOURNAL REPORT\n\n");
    let cloneTasks = [...tasks];
    cloneTasks.sort((a, b) => a.date.localeCompare(b.date));
    cloneTasks.forEach(entry => {
      lines.push(`Date: ${entry.date} ${entry.type === "future" ? `[Deadline: ${entry.deadline}]` : ''}`);
      lines.push(`Status: ${entry.type === "future" ? (entry.missed ? 'Missed' : 'Pending') : (entry.completed ? 'Completed' : 'Incomplete')}`);
      let cats = Object.keys(entry.sections);
      cats.forEach(cat => {
        lines.push(`  Section: ${cat}`);
        entry.sections[cat].forEach((task, i) => {
          lines.push(`     ${i + 1}. ${task}`);
        });
      });
      lines.push('');
    });
    lines.push("\nPrevious Tasks:");
    let prevs = cloneTasks.filter(t => t.type === "accomplished" && t.date < new Date().toISOString().slice(0, 10));
    prevs.forEach(entry => {
      lines.push(`Date: ${entry.date}`);
      let cats = Object.keys(entry.sections);
      cats.forEach(cat => {
        lines.push(`   Section: ${cat}`);
        entry.sections[cat].forEach((task, i) => lines.push(`     ${i + 1}. ${task}`));
      });
    });
    return lines.join('\n');
  }

  function showReportModal(reportTxt) {
    modalRemove();
    let modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <h2>JOURNAL REPORT</h2>
      <div style="margin-bottom:16px;">
        <button class="btn" onclick="downloadPDF()">Download PDF</button>
        <button class="btn" onclick="clearAll()">Clear All</button>
      </div>
      <pre style="text-align:left; max-height:45vh; overflow:auto; background:#23242a; border-radius:8px; padding: 12px; font-family: monospace; font-size: 1em;">${reportTxt}</pre>
      <div class="modal-backdrop"></div>
    `;
    document.body.appendChild(modal);
    window.reportTxt = reportTxt;
    document.querySelector('.modal-backdrop').onclick = modalRemove;
  }

  function downloadPDF() {
    let doc = new window.jspdf.jsPDF();
    let lines = window.reportTxt.split('\n');
    doc.setFont('courier', 'normal');
    doc.setFontSize(12);
    let marginLeft = 14;
    let marginTop = 20;
    let lineCount = 0;
    for (let i = 0; i < lines.length; i++) {
      doc.text(lines[i], marginLeft, marginTop + lineCount * 7);
      lineCount++;
      if ((marginTop + lineCount * 7) > 270) {
        doc.addPage();
        marginTop = 20;
        lineCount = 0;
      }
    }
    doc.save('Journal_Report.pdf');
  }

  function clearAll() {
    if (confirm("Permanently delete all entries and reset journal?")) {
      tasks = [];
      saveTasks(tasks);
      renderTasks();
      modalRemove();
    }
  }

  function createModal(title, content) {
    modalRemove();
    let backdrop = document.createElement('div');
    backdrop.className = "modal-backdrop";
    backdrop.onclick = modalRemove;
    let modal = document.createElement('div');
    modal.className = "modal";
    modal.innerHTML = `<h2>${title}</h2>${content}`;
    document.body.appendChild(backdrop);
    return modal;
  }

  function modalRemove() {
    document.querySelectorAll('.modal,.modal-backdrop').forEach(el => el.remove());
  }

  function saveTasks(ts) {
    localStorage.setItem('journalTasks', JSON.stringify(ts));
  }

  function loadTasks() {
    try {
      return JSON.parse(localStorage.getItem('journalTasks') || '[]');
    } catch {
      return [];
    }
  }
</script>
</body>
</html>
