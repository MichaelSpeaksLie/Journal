<html lang="en"></html>
<head>
  <meta charset="UTF-8" />
  <title>Journal</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
  <!-- Firebase Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-database-compat.js"></script>
  <!-- Firebase Auth -->
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-auth-compat.js"></script>
  <!-- Flatpickr CSS + JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    body {
      background: #18191A;
      color: #e4e6eb;
      font-family: 'Fira Mono', 'Consolas', 'Menlo', monospace;
      margin: 0;
    }
    h1 {
      text-align: center;
      letter-spacing: 2px;
      margin: 40px 0 28px 0;
      font-size: 2.8em;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-bottom: 32px;
    }
    .btn {
      background: #242526;
      color: #fff;
      border: 1px solid #35363a;
      padding: 14px 28px;
      border-radius: 6px;
      font-family: inherit;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.14s;
      font-size: 1.07em;
      box-shadow: 0 1px 3px #0a0a0a15;
      letter-spacing: 1px;
    }
    .btn:hover {
      background: #3a3b3c;
      color: #61dafb;
      box-shadow: 0 2px 8px #3333cc22;
    }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222325;
      border: 2px solid #61dafb;
      border-radius: 16px;
      box-shadow: 0 6px 32px #16193cbb;
      z-index: 9999;
      width: 360px;
      max-height: 80vh;
      overflow: auto;
      padding: 28px;
      color: #e4e6eb;
      text-align: center;
    }
    .modal h2 {
      margin-bottom: 18px;
      font-size: 1.4em;
    }
    .modal-backdrop {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(40,41,43,0.6);
      z-index: 9998;
    }
    .note {
      background: #222325;
      border: 1.8px solid #313235;
      border-radius: 10px;
      margin: 24px auto;
      padding: 20px 18px;
      box-shadow: 0 3px 10px #13141540;
      max-width: 700px;
      font-size: 1.08em;
    }
    .note .section-header {
      font-weight: bold;
      margin-top: 14px;
      margin-bottom: 4px;
      color: #87f7ca;
      font-size: 1.08em;
    }
    .note .completed { color: #22ff3b; text-decoration: line-through;}
    .note .incomplete, .note .pending { color: #ffd700;}
    .note .missed { color: #ff2266;}
    .disabled {
      opacity: 0.62;
      pointer-events: none;
      text-decoration: line-through;
    }
    textarea, input[type="date"], input[type="text"], input[type="datetime-local"], select {
      background: #23242a;
      color: #e4e6eb;
      border: 1.2px solid #38393c;
      border-radius: 5px;
      width: 100%;
      padding: 11px 18px;
      font-size: 1.09em;
      font-family: inherit;
      margin-bottom: 12px;
    }
    textarea {resize: vertical;}
    textarea:focus, input:focus, select:focus { border: 1.8px solid #61dafb; outline: none;}
    .notif {
      position: fixed;
      right: 32px;
      bottom: 32px;
      background: #ffe066;
      color: #242526;
      padding: 18px 23px;
      border-radius: 12px;
      border: 2.2px solid #856404;
      box-shadow: 0 4px 20px #19191977;
      z-index: 999;
      font-size: 1.22em;
      display: flex;
      align-items: center;
      font-family: inherit;
    }
    .notif .close {
      background: none;
      border: none;
      font-size: 1.1em;
      margin-left: 18px;
      cursor: pointer;
      color: #856404;
      padding: 4px 10px;
    }
    .task-list {
      margin: 14px 0 0 0;
      padding-left: 10px;
      text-align: left;
      max-height: 160px;
      overflow-y: auto;
      border: 1px solid #38393c;
      border-radius: 4px;
      background: #1d1e21;
    }
    .modal-btn-group {
      display: flex;
      justify-content: center;
      margin-top: 16px;
      gap: 14px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <h1>Journal</h1>
  <div id="loginContainer">
    <form id="loginForm" style="max-width:340px;margin:40px auto 0 auto;padding:24px;background:#23242a;border-radius:10px;box-shadow:0 2px 12px #19191944;">
      <h2 style="color:#61dafb;">Login</h2>
      <input type="email" id="loginEmail" placeholder="Email" required style="margin-bottom:12px;">
      <input type="password" id="loginPassword" placeholder="Password" required style="margin-bottom:12px;">
      <button class="btn" type="submit">Login</button>
      <div id="loginError" style="color:#ff2266;margin-top:10px;"></div>
    </form>
  </div>
  <div id="appContainer" style="display:none;">
    <div class="controls">
      <button class="btn" onclick="startTaskEntry()">âž• Add Entry</button>
      <button class="btn" onclick="showPrevTasks()">Prev. Tasks</button>
      <button class="btn" onclick="exportAndClear()">Export & Clear</button>
      <button class="btn" onclick="logout()">Logout</button>
    </div>
    <div id="tasks"></div>
    <div id="notification"></div>
    <div id="report" style="display:none;"></div>
  </div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDYgLGTH8W6PDw_nd-YZgCLHThF_Lkf3Bg",
    authDomain: "journal-d570e.firebaseapp.com",
    databaseURL: "https://journal-d570e-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "journal-d570e",
    storageBucket: "journal-d570e.firebasestorage.app",
    messagingSenderId: "625726240720",
    appId: "1:625726240720:web:a064b16b8f1ba8fb6f6bd5",
    measurementId: "G-H1EF9X452X"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  const auth = firebase.auth();

  // Show/hide app based on auth state
  auth.onAuthStateChanged(function(user) {
    if (user && user.email === "imanuragkrverma@gmail.com") {
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('appContainer').style.display = '';
      loadTasksFromDatabase();
    } else {
      document.getElementById('loginContainer').style.display = '';
      document.getElementById('appContainer').style.display = 'none';
    }
  });

  // Login form handler
  document.addEventListener('DOMContentLoaded', function() {
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
      loginForm.onsubmit = function(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        auth.signInWithEmailAndPassword(email, password)
          .then(() => {
            document.getElementById('loginError').textContent = '';
          })
          .catch(err => {
            document.getElementById('loginError').textContent = err.message;
          });
      };
    }
  });

  // Logout function
  function logout() {
    auth.signOut();
  }

  let tasks = [];
  let notifDismissed = false;

  // Load tasks from Realtime Database at start
  async function loadTasksFromDatabase() {
    try {
      console.log("Attempting to load tasks from database...");
      const snapshot = await database.ref('journals/userTasks').once('value');
      console.log("Database snapshot:", snapshot.val());
      if (snapshot.exists()) {
        tasks = snapshot.val().tasks || [];
      } else {
        tasks = [];
      }
      console.log("Loaded tasks:", tasks);
      renderTasks();
      checkNotifications();
    } catch (error) {
      console.error("Error loading tasks from Realtime Database:", error);
      tasks = [];
      renderTasks();
    }
  }

  // Save tasks to Realtime Database
  async function saveTasksToDatabase(tasksArray) {
    try {
      console.log("Attempting to save tasks:", tasksArray);
      console.log("Current user:", auth.currentUser);
      console.log("Database reference:", database.ref('journals/userTasks'));
      
      const result = await database.ref('journals/userTasks').set({ tasks: tasksArray });
      console.log("Save result:", result);
      console.log("Tasks saved to Realtime Database successfully");
    } catch (error) {
      console.error("Error saving tasks to Realtime Database:", error);
      console.error("Error code:", error.code);
      console.error("Error message:", error.message);
    }
  }

  // Replace local save/load functions with Realtime Database versions
  function saveTasks(ts) {
    console.log("ðŸ”¥ FIREBASE saveTasks function called with:", ts);
    saveTasksToDatabase(ts);
  }

  function loadTasks() {
    // This function is now async; provide a dummy fallback for sync calls before data load
    return tasks;
  }

  // On page load, fetch tasks from Realtime Database
  window.onload = () => {
  // Auth state will trigger loadTasksFromDatabase after login
  };
  // ...existing code...

  function startTaskEntry() {
    stepDateInput();
  }
</script>
</body>
</html>
